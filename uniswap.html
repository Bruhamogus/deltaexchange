<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DELTA to ETH Swap</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.4.7/dist/ethers.umd.min.js"></script>
</head>
<body>
    <h1>Swap DELTA for ETH</h1>
    <button id="connectButton">Connect Wallet</button>
    <br><br>
    <input type="number" id="amount" placeholder="Amount of DELTA to swap">
    <button id="swapButton" disabled>Swap DELTA for ETH</button>

    <script>
        const DELTA_ADDRESS = "0x9ed933f2241135AE6b37e5Ad3EbD6D2a4D989fec"; // DELTA token address on Base
        const UNISWAP_ROUTER_ADDRESS = "0x5C69bEe701ef814a2B6a3EDD8bD49bF0B11A0e9f"; // Uniswap router address
        const TOKEN_DECIMALS = 18; // Usually ERC-20 tokens have 18 decimals, adjust if needed

        let provider;
        let signer;
        let userAddress;
        let delTokenContract;
        let routerContract;

        // Connect MetaMask wallet
        async function connectWallet() {
            if (window.ethereum) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                delTokenContract = new ethers.Contract(DELTA_ADDRESS, ["function approve(address spender, uint256 amount) public returns (bool)"], signer);
                routerContract = new ethers.Contract(UNISWAP_ROUTER_ADDRESS, [
                    "function swapExactTokensForETH(uint256 amountIn, uint256 amountOutMin, address[] calldata path, address to, uint256 deadline) external",
                    "function getAmountsOut(uint256 amountIn, address[] calldata path) external view returns (uint256[] memory amounts)"
                ], signer);
                document.getElementById("swapButton").disabled = false;
            } else {
                alert("Please install MetaMask!");
            }
        }

        // Approve DELTA token for Uniswap swap
        async function approveDELTA(amount) {
            const delAmount = ethers.utils.parseUnits(amount.toString(), TOKEN_DECIMALS);
            const approval = await delTokenContract.approve(UNISWAP_ROUTER_ADDRESS, delAmount);
            await approval.wait();
        }

        // Swap DELTA for ETH
        async function swapDELTAForETH(amount) {
            const delAmount = ethers.utils.parseUnits(amount.toString(), TOKEN_DECIMALS);
            const path = [DELTA_ADDRESS, "0xC02aaA39b223FE8D0A0e5C4F27EAD9083C756Cc2"]; // DELTA to WETH (wrapped ETH)
            const deadline = Math.floor(Date.now() / 1000) + 60 * 20; // 20 minutes from now

            // Get minimum ETH out value from Uniswap router
            const amountsOut = await routerContract.getAmountsOut(delAmount, path);
            const minETHOut = amountsOut[1].mul(95).div(100); // Get 95% of the expected amount (slippage protection)

            // Approve DELTA token first
            await approveDELTA(amount);

            // Swap DELTA for ETH on Uniswap
            const swapTx = await routerContract.swapExactTokensForETH(
                delAmount,
                minETHOut,
                path,
                userAddress,
                deadline
            );
            await swapTx.wait();
            alert("Swap successful!");
        }

        // Swap Button click handler
        document.getElementById("swapButton").addEventListener("click", async () => {
            const amount = document.getElementById("amount").value;
            if (amount > 0) {
                await swapDELTAForETH(amount);
            } else {
                alert("Please enter a valid amount.");
            }
        });

        // Connect wallet button
        document.getElementById("connectButton").addEventListener("click", connectWallet);
    </script>
</body>
</html>
